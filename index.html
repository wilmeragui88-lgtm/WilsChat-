<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>WilsChat Pro</title>
<style>
/* Dise√±o Profesional - Est√©tica Moderna */
:root {
    --primary: #075e54;
    --primary-dark: #128c7e;
    --accent: #25d366;
    --bg-chat: #efeae2;
    --white: #ffffff;
    --gray-light: #f0f2f5;
    --text-main: #111b21;
    --text-meta: #667781;
}

/* Mejora: Soporte para Modo Oscuro Autom√°tico */
@media (prefers-color-scheme: dark) {
    :root {
        --primary: #202c33;
        --primary-dark: #111b21;
        --accent: #00a884;
        --bg-chat: #0b141a;
        --white: #111b21;
        --gray-light: #202c33;
        --text-main: #e9edef;
        --text-meta: #8696a0;
    }
    body { background: #0b141a; }
    #login { background: #222e35; }
    #chatMenuWindow { background: #222e35; border: 1px solid #3b4a54; }
    .other { background: #202c33 !important; color: #e9edef; }
    .me { background: #005c4b !important; color: #e9edef; }
    #username, #userSearch { background: #2a3942; color: white; border-color: #3b4a54; }
    .status:hover { background: #2a3942; }
}

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #d1d7db; margin: 0; padding: 0; color: var(--text-main);
    height: 100vh; display: flex; flex-direction: column; overflow: hidden;
}

header {
    background: var(--primary); color: #ffffff; padding: 10px 16px;
    display: flex; justify-content: space-between; align-items: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1); flex-shrink: 0; z-index: 1000;
}

header strong { font-size: 20px; letter-spacing: 0.5px; }

#login {
    display: flex; flex-direction: column; margin: auto; background: var(--white);
    border-radius: 20px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    width: 90%; max-width: 450px; text-align: center;
}
#login h2 { margin-top: 0; color: var(--primary); font-size: 28px; margin-bottom: 10px; }
#login p { color: var(--text-meta); margin-bottom: 25px; }
#username {
    padding: 16px; border: 2px solid #eee; border-radius: 12px; font-size: 18px;
    margin-bottom: 20px; outline: none; transition: border-color 0.3s;
}
#username:focus { border-color: var(--primary); }
#enterBtn {
    background: var(--primary); color: white; border: none; padding: 18px;
    border-radius: 12px; font-weight: bold; font-size: 18px; cursor: pointer;
    transition: background 0.3s;
}
#enterBtn:hover { background: var(--primary-dark); }

#chatMenuWindow {
    position: fixed; top: 60px; left: 10px; width: 280px; max-height: 80vh;
    background: var(--white); border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    padding: 8px; display: none; z-index: 1100; overflow-y: auto;
}

#userSearch {
    width: 100%; padding: 8px 12px; border: 1px solid #eee; border-radius: 20px;
    margin-bottom: 10px; outline: none; box-sizing: border-box; font-size: 14px;
    background: var(--gray-light);
}

.status {
    display: flex; align-items: center; padding: 10px; border-radius: 8px; cursor: pointer;
    margin-bottom: 2px; transition: background 0.2s;
}
.status:hover { background: var(--gray-light); }
.status .avatar {
    width: 40px; height: 40px; border-radius: 50%; color: #fff; display: flex; 
    align-items: center; justify-content: center; font-weight: bold; margin-right: 12px; flex-shrink: 0;
    background-size: cover; background-position: center; position: relative;
}

#menuBadge {
    position: absolute; top: -2px; right: -2px; background: var(--accent);
    width: 10px; height: 10px; border-radius: 50%; border: 2px solid var(--primary); display: none;
}

#chat { 
    display: none; flex-direction: column; flex: 1; overflow: hidden; 
    width: 100%; max-width: 800px; margin: 0 auto; background: var(--bg-chat);
}

#messages, #privateMessages {
    flex: 1; padding: 16px; overflow-y: auto; display: flex; flex-direction: column;
    background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png');
}

.msg {
    margin-bottom: 8px; padding: 8px 12px; border-radius: 8px; max-width: 85%;
    position: relative; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); font-size: 14.5px;
    line-height: 1.4; word-wrap: break-word; cursor: pointer;
}
.me { background: #d9fdd3; align-self: flex-end; border-top-right-radius: 0; }
.other { background: var(--white); align-self: flex-start; border-top-left-radius: 0; }

.msg img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }
.msg audio { max-width: 100%; height: 35px; margin-top: 8px; }

.meta { font-size: 11px; color: var(--text-meta); margin-top: 4px; display: flex; justify-content: flex-end; align-items: center; gap: 3px; }

.controls, #privateControls {
    background: var(--gray-light); padding: 10px 16px; display: flex; 
    align-items: flex-end; gap: 10px; flex-shrink: 0;
}
.controls textarea, #privateControls textarea {
    flex: 1; background: var(--white); border: none; padding: 10px 16px;
    border-radius: 20px; font-size: 15px; max-height: 120px; outline: none;
    resize: none; font-family: inherit; line-height: 20px; color: var(--text-main);
}

.btn-round {
    width: 40px; height: 40px; border-radius: 50%; border: none;
    background: var(--primary); color: white; cursor: pointer;
    display: flex; align-items: center; justify-content: center; font-size: 18px;
    flex-shrink: 0; transition: 0.2s;
}

@keyframes pulse-red {
    0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
    70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
    100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}
.recording { animation: pulse-red 1.5s infinite; background: #e74c3c !important; }

#privateChatFull {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-chat); z-index: 2000; display: none; flex-direction: column;
}
#privateHeader {
    background: var(--primary); color: white; padding: 10px 16px;
    display: flex; align-items: center; gap: 15px; flex-shrink: 0;
}

#previewModal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); z-index: 3000; display: none;
    flex-direction: column; align-items: center; justify-content: center;
}
#previewImg { max-width: 90%; max-height: 70%; border-radius: 8px; }

.date-sep {
    align-self: center; background: rgba(255,255,255,0.8); padding: 5px 12px;
    border-radius: 8px; font-size: 12px; color: var(--text-meta); margin: 10px 0;
    text-transform: uppercase; font-weight: bold;
}
</style>
</head>
<body>

<header>
  <strong>WilsChat Pro</strong>
  <div id="chatMenuBtn" style="display:none; cursor:pointer; position:relative;">
    <span style="font-size:24px;">‚ãÆ</span>
    <div id="menuBadge"></div>
  </div>
</header>

<div id="chatMenuWindow">
    <div style="padding:10px; border-bottom:1px solid #eee; text-align: center;">
        <div id="myAvatarDisplay" class="avatar" style="width:60px; height:60px; margin:0 auto 10px; border:2px solid var(--primary); background-color:#ccc; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; background-size:cover;">üë§</div>
        <input type="file" id="avatarInput" accept="image/*" hidden>
        <input type="text" id="userSearch" placeholder="Buscar contacto...">
        <div style="display:flex; align-items:center; gap:5px; margin-top:5px;">
            <small>Color:</small>
            <input type="color" id="userColorPicker" style="flex:1; border:none; height:25px; cursor:pointer;">
        </div>
    </div>
    <div id="usersList"></div>
</div>

<div id="login">
  <h2>¬°Hola!</h2>
  <p>Escribe tu nombre para empezar a chatear.</p>
  <input id="username" placeholder="Tu nombre aqu√≠..." autocomplete="off">
  <button id="enterBtn">Entrar al Chat</button>
</div>

<div id="chat">
  <div id="messages"></div>
  <div class="controls">
    <button class="btn-round" onclick="photoInput.click()" style="background:#667781">üì∑</button>
    <input type="file" id="photoInput" accept="image/*" hidden>
    <textarea id="text" placeholder="Escribe un mensaje..." rows="1"></textarea>
    <button id="recordBtn" class="btn-round" style="background:#667781">üé§</button>
    <button id="sendBtn" class="btn-round">‚û§</button>
  </div>
</div>

<div id="privateChatFull">
  <div id="privateHeader">
    <button id="closePrivateBtn" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚Üê</button>
    <div style="flex:1">
        <div id="privateUserName" style="font-weight:bold; font-size:16px;"></div>
        <div id="typingStatus" style="font-size:12px; color:#dcf8c6; height:14px;"></div>
    </div>
  </div>
  <div id="privateMessages"></div>
  <div id="privateControls">
    <button id="recordBtnPrivate" class="btn-round" style="background:#667781">üé§</button>
    <textarea id="privateText" placeholder="Mensaje privado..." rows="1"></textarea>
    <button id="privateSendBtn" class="btn-round">‚û§</button>
  </div>
</div>

<div id="previewModal">
    <img id="previewImg">
    <div style="margin-top:20px; display:flex; gap:20px;">
        <button id="cancelPreview" style="background:#e74c3c; color:white; border:none; padding:10px 20px; border-radius:20px;">Cancelar</button>
        <button id="sendPreview" style="background:#25d366; color:white; border:none; padding:10px 20px; border-radius:20px;">Enviar Foto</button>
    </div>
</div>

<audio id="sndSend" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" preload="auto"></audio>
<audio id="sndReceive" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
var firebaseConfig={apiKey:"AIzaSyAEkdn1nVDbrJEQY13JrE-peN1JkXrOy24",authDomain:"wilschat-1b27d.firebaseapp.com",databaseURL:"https://wilschat-1b27d-default-rtdb.firebaseio.com",projectId:"wilschat-1b27d",storageBucket:"wilschat-1b27d.appspot.com",messagingSenderId:"550632985900",appId:"1:550632985900:web:c886e89b4330560b6ac889"};
firebase.initializeApp(firebaseConfig);

var db=firebase.database(), storage=firebase.storage();
var user="", presenceKey=null, currentRef=null, privateWith=null, typingTimeout, selectedFile=null;
var unreadCounts = {}, userColor = "#128c7e", userAvatar = "", allUsersCached = [];

/* Mejora: Solicitar permisos de notificaci√≥n al entrar */
function requestNotifyPermission() {
    if ("Notification" in window) {
        Notification.requestPermission();
    }
}

function sendNotification(title, body) {
    if (document.hidden && Notification.permission === "granted") {
        new Notification(title, { body: body, icon: 'https://cdn-icons-png.flaticon.com/512/134/134914.png' });
        playReceive(); // Sonido incluso si est√° bloqueado
    }
}

function playSend(){ document.getElementById("sndSend").play().catch(()=>{}); }
function playReceive(){ document.getElementById("sndReceive").play().catch(()=>{}); }
function chatId(a,b){return [a,b].sort().join("_");}
function time(ts){return new Date(ts).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});}
function formatDate(ts){ let d=new Date(ts); if(d.toDateString()===(new Date()).toDateString()) return "Hoy"; return d.toLocaleDateString(); }
function autoGrow(el) { el.style.height = "20px"; el.style.height = (el.scrollHeight) + "px"; }

function addMsg(m, container, msgKey){
  if(!m) return;
  if(m.user && m.user !== user) {
      playReceive();
      if(container.id === "privateMessages") {
          sendNotification("Nuevo mensaje privado de " + m.user, m.text || "üì∑ Foto o üé§ Audio");
      } else if(container.id === "messages") {
          sendNotification("Mensaje en el grupo: " + m.user, m.text || "Archivo multimedia");
      }
  }
  var div=document.createElement("div"); div.className="msg "+(m.user===user?"me":"other");
  div.id = "m_" + msgKey;
  if(m.system){
      div.className="system"; div.style.alignSelf="center"; div.style.fontSize="11px";
      div.textContent=m.text+" ‚Ä¢ "+time(m.ts); container.appendChild(div); 
      container.scrollTop=container.scrollHeight; return;
  }
  if(m.user === user) {
      div.onclick = () => { if(confirm("¬øEliminar este mensaje?")) {
          let path = container.id === "messages" ? "mensajes/" : "mensajes_privados/" + chatId(user, privateWith) + "/";
          db.ref(path + msgKey).remove();
      }};
  } else if(container.id === "messages") { div.onclick = () => openPrivateFull(m.user); }
  let uColor = m.color || "#667781";
  let content = `<strong style="color:${uColor}">${m.user}</strong><br>`;
  if(m.type==="image") content += `<img src="${m.url}" loading="lazy">`;
  else if(m.type==="audio") content += `<audio controls src="${m.url}"></audio>`;
  else content += m.text.replace(/\n/g, '<br>');
  let statusStr = (m.user===user && container.id==="privateMessages") ? (m.leido ? " <span style='color:#34b7f1'>‚úî‚úî</span>" : " <span style='color:var(--text-meta)'>‚úî</span>") : "";
  div.innerHTML = content + `<div class="meta">${time(m.ts)}${statusStr}</div>`;
  container.appendChild(div); container.scrollTop = container.scrollHeight;
}

enterBtn.onclick=function(){
  if(!username.value.trim()) return; user=username.value.trim();
  requestNotifyPermission();
  userColor = "#"+Math.floor(Math.random()*16777215).toString(16);
  userColorPicker.value = userColor;
  login.style.display="none"; chat.style.display="flex";
  document.getElementById("chatMenuBtn").style.display="block";
  db.ref("users/"+user).set({name:user, color:userColor, avatar: "", lastSeen:Date.now()});
  var ref=db.ref("presence").push({name:user}); presenceKey=ref.key; ref.onDisconnect().remove();
  db.ref("mensajes").push({system:true,text:user+" entr√≥",ts:Date.now()});
  listenPublic(); listenForPrivateNotif(); updateUsers();
}

myAvatarDisplay.onclick = () => avatarInput.click();
avatarInput.onchange = e => {
    let f = e.target.files[0]; if(!f) return;
    storage.ref("avatars/"+user).put(f).then(s=>s.ref.getDownloadURL().then(u=>{
        userAvatar = u; myAvatarDisplay.style.backgroundImage = `url(${u})`;
        myAvatarDisplay.textContent = ""; db.ref("users/"+user+"/avatar").set(u);
    }));
};

userColorPicker.onchange = (e) => { userColor = e.target.value; db.ref("users/"+user+"/color").set(userColor); };

function listenPublic(){
  var container=document.getElementById("messages");
  db.ref("mensajes").limitToLast(50).on("child_added", s=>addMsg(s.val(), container, s.key));
  db.ref("mensajes").on("child_removed", s => { let el=document.getElementById("m_"+s.key); if(el) el.remove(); });
}

function listenForPrivateNotif(){
    db.ref("mensajes_privados").on("child_added", (snap) => {
        if(snap.key.includes(user)){
            snap.ref.limitToLast(1).on("child_added", (mSnap) => {
                let m = mSnap.val();
                if(m.user !== user && privateWith !== m.user){
                    unreadCounts[m.user] = (unreadCounts[m.user] || 0) + 1;
                    document.getElementById("menuBadge").style.display = "block";
                    updateUsers(); playReceive(); 
                    sendNotification("Nuevo mensaje de " + m.user, m.text || "Multimedia");
                }
            });
        }
    });
}

userSearch.oninput = function() { renderUserList(this.value.toLowerCase()); };

function updateUsers(){
  db.ref("users").on("value", u => {
    db.ref("presence").on("value", p => {
      var online=[]; p.forEach(c=>online.push(c.val().name));
      allUsersCached = [];
      u.forEach(c => { if(c.key !== user) {
            allUsersCached.push({ name: c.key, color: c.val().color || "#075e54", avatar: c.val().avatar || "", isOnline: online.includes(c.key) });
      }});
      renderUserList();
    });
  });
}

function renderUserList(filter = ""){
  var html="<strong style='padding:10px; display:block; color:var(--primary)'>CONTACTOS</strong>";
  allUsersCached.forEach(u => {
    if(u.name.toLowerCase().includes(filter)){
      let count = unreadCounts[u.name] ? `<span style="background:var(--accent); color:white; border-radius:10px; padding:2px 7px; font-size:11px;">${unreadCounts[u.name]}</span>` : "";
      let statusDot = u.isOnline ? "border: 2px solid #25d366;" : "border: 2px solid #ccc;";
      let avatarStyle = u.avatar ? `background-image:url(${u.avatar}); color:transparent;` : `background-color:${u.color};`;
      html += `<div class="status" onclick="openPrivateFull('${u.name}')">
                <div class="avatar" style="${avatarStyle} ${statusDot}">${u.name.charAt(0)}</div>
                <div style="flex:1"><span class="name">${u.name}</span> <small style="display:block; font-size:10px; color:${u.isOnline?'#25d366':'#667781'}">${u.isOnline?'en l√≠nea':'desconectado'}</small></div> ${count}
             </div>`;
    }
  });
  document.getElementById("usersList").innerHTML = html;
}

function openPrivateFull(name){
  privateWith=name; unreadCounts[name] = 0; 
  if(Object.values(unreadCounts).every(v => v === 0)) document.getElementById("menuBadge").style.display="none";
  document.getElementById("privateUserName").textContent=name;
  document.getElementById("privateChatFull").style.display="flex";
  var container=document.getElementById("privateMessages"); container.innerHTML="";
  let path = "mensajes_privados/" + chatId(user, name);
  db.ref(path).on("value", snap => { snap.forEach(c => { if(c.val().user === name && !c.val().leido) c.ref.update({leido:true}); }); });
  db.ref(path).limitToLast(50).on("child_added", s => addMsg(s.val(), container, s.key));
  db.ref(path).on("child_removed", s => { let el=document.getElementById("m_"+s.key); if(el) el.remove(); });
  db.ref("typing/"+user+"/"+name).on("value", s => { document.getElementById("typingStatus").textContent = s.exists() ? "escribiendo..." : ""; });
  updateUsers();
}

sendBtn.onclick=() => {
  let txt=document.getElementById("text"); if(!txt.value.trim()) return;
  db.ref("mensajes").push({user:user, text:txt.value, color:userColor, ts:Date.now()}); 
  txt.value=""; txt.style.height="20px"; playSend();
};

photoInput.onchange = e => {
    selectedFile = e.target.files[0]; if(!selectedFile) return;
    let reader = new FileReader();
    reader.onload = (ex) => { previewImg.src = ex.target.result; previewModal.style.display = "flex"; };
    reader.readAsDataURL(selectedFile);
};

sendPreview.onclick = () => {
    previewModal.style.display = "none";
    var r=storage.ref("photos/"+Date.now()+selectedFile.name); 
    r.put(selectedFile).then(s=>s.ref.getDownloadURL().then(u=>{
        db.ref("mensajes").push({user:user, type:"image", url:u, color:userColor, ts:Date.now()}); 
        playSend(); photoInput.value="";
    }));
};
cancelPreview.onclick = () => { previewModal.style.display="none"; photoInput.value=""; };

privateSendBtn.onclick=() => {
  let txt=document.getElementById("privateText"); if(!txt.value.trim()||!privateWith) return;
  db.ref("mensajes_privados/"+chatId(user,privateWith)).push({user:user, text:txt.value, color:userColor, ts:Date.now(), leido:false}); 
  db.ref("typing/"+privateWith+"/"+user).remove(); txt.value=""; txt.style.height="20px"; playSend();
};

closePrivateBtn.onclick=() => { 
  if(privateWith) { db.ref("typing/"+privateWith+"/"+user).remove(); db.ref("typing/"+user+"/"+privateWith).off(); db.ref("mensajes_privados/"+chatId(user,privateWith)).off(); }
  document.getElementById("privateChatFull").style.display="none"; privateWith=null; 
};

chatMenuBtn.onclick=() => { let w=document.getElementById("chatMenuWindow"); w.style.display = w.style.display==="block"?"none":"block"; };

let rec, chunks = [];
async function toggleRecording(btn, isPrivate) {
    if (!rec || rec.state === "inactive") {
        try {
            var st = await navigator.mediaDevices.getUserMedia({ audio: true });
            rec = new MediaRecorder(st); chunks = [];
            rec.ondataavailable = e => chunks.push(e.data);
            rec.onstop = () => {
                var b = new Blob(chunks, { type: "audio/webm" });
                var r = storage.ref("audios/" + Date.now() + ".webm");
                r.put(b).then(s => s.ref.getDownloadURL().then(u => {
                    let path = isPrivate ? "mensajes_privados/" + chatId(user, privateWith) : "mensajes";
                    db.ref(path).push({ user: user, type: "audio", url: u, color: userColor, ts: Date.now(), leido: false });
                    playSend();
                }));
            };
            rec.start(); btn.classList.add("recording");
        } catch (err) { alert("Micr√≥fono no disponible"); }
    } else {
        rec.stop(); btn.classList.remove("recording");
    }
}

recordBtn.onclick = function() { toggleRecording(this, false); };
recordBtnPrivate.onclick = function() { toggleRecording(this, true); };

document.getElementById("text").oninput = function() { autoGrow(this); };
document.getElementById("privateText").oninput = function() { 
    autoGrow(this); if (!privateWith) return;
    db.ref("typing/"+privateWith+"/"+user).set(true);
    clearTimeout(typingTimeout);
    typingTimeout = setTimeout(() => { if (privateWith) db.ref("typing/"+privateWith+"/"+user).remove(); }, 2000);
};
document.getElementById("text").onkeydown = e => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendBtn.click(); } };
document.getElementById("privateText").onkeydown = e => { if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); privateSendBtn.click(); } };
</script>
</body>
</html>
