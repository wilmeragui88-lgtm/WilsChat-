<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>WilsChat</title>

<style>
body{font-family:Arial;background:#f2f2f2;margin:0}
header{background:#4CAF50;color:#fff;padding:10px}
#topMenu{display:flex;justify-content:space-between;align-items:center}
#userStatus{font-size:14px}
.status{margin-right:10px}
.online{color:#aaffaa}
.offline{color:#ddd}

#login,#chat{display:flex;flex-direction:column;height:calc(100vh - 70px);margin:10px;background:#fff;border-radius:8px;padding:10px}
#chat{display:none}

input,button{padding:10px;font-size:16px;border-radius:8px;border:1px solid #ccc}
button{background:#4CAF50;color:#fff;border:none;cursor:pointer}

#messages{flex:1;border:1px solid #ddd;padding:8px;overflow-y:auto;margin-bottom:8px}
.msg{margin-bottom:6px;padding:6px 10px;border-radius:6px;background:#eee}
.me{background:#c8f7c5;text-align:right}
.system{text-align:center;font-style:italic;color:#666;background:none}
.meta{font-size:.75em;color:#666}
img{max-width:200px;border-radius:6px;margin-top:6px}
audio{margin-top:6px;width:200px}

.controls{display:flex;gap:6px}
</style>
</head>

<body>

<header>
  <div id="topMenu">
    <strong>WilsChat</strong>
    <div id="userStatus"></div>
  </div>
</header>

<div id="login">
<h3>Ingresa tu nombre</h3>
<input id="username" placeholder="Tu nombre">
<button id="enterBtn">Entrar</button>
</div>

<div id="chat">
<div id="messages"></div>

<div class="controls">
<input id="text" placeholder="Escribe un mensaje" style="flex:1">
<input type="file" id="photoInput" accept="image/*" hidden>
<button onclick="photoInput.click()">ðŸ“·</button>
<button id="recordBtn">ðŸŽ¤</button>
<button id="sendBtn">Enviar</button>
</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>

<script>
var firebaseConfig={
apiKey:"AIzaSyAEkdn1nVDbrJEQY13JrE-peN1JkXrOy24",
authDomain:"wilschat-1b27d.firebaseapp.com",
databaseURL:"https://wilschat-1b27d-default-rtdb.firebaseio.com",
projectId:"wilschat-1b27d",
storageBucket:"wilschat-1b27d.appspot.com",
messagingSenderId:"550632985900",
appId:"1:550632985900:web:c886e89b4330560b6ac889"
};
firebase.initializeApp(firebaseConfig);

var db=firebase.database();
var storage=firebase.storage();
var user="";
var presenceKey=null;

function time(ts){return new Date(ts).toLocaleTimeString()}

function addMsg(m){
var div=document.createElement("div");
div.className="msg"+(m.user===user?" me":"");
if(m.system){
div.className+=" system";
div.textContent=m.text+" â€” "+time(m.ts);
messages.appendChild(div);return;
}
div.innerHTML="<strong>"+m.user+":</strong> ";
if(m.type==="image"){
var i=document.createElement("img");i.src=m.url;div.appendChild(i);
}else if(m.type==="audio"){
var a=document.createElement("audio");a.controls=true;a.src=m.url;div.appendChild(a);
}else{
div.innerHTML+=" "+m.text;
}
var meta=document.createElement("div");
meta.className="meta";meta.textContent=time(m.ts);
div.appendChild(meta);
messages.appendChild(div);
messages.scrollTop=messages.scrollHeight;
}

enterBtn.onclick=function(){
if(!username.value.trim())return;
user=username.value.trim();
login.style.display="none";
chat.style.display="flex";

/* Guardar usuario */
db.ref("users/"+user).set({name:user,lastSeen:Date.now()});

/* Presencia */
var ref=db.ref("presence").push({name:user});
presenceKey=ref.key;
ref.onDisconnect().remove();

db.ref("mensajes").push({system:true,text:user+" entrÃ³ al chat",ts:Date.now()});
};

sendBtn.onclick=function(){
if(!text.value.trim())return;
db.ref("mensajes").push({user:user,text:text.value,ts:Date.now()});
text.value="";
};

db.ref("mensajes").limitToLast(200).on("child_added",s=>{
if(s.val())addMsg(s.val());
});

/* Fotos */
photoInput.onchange=function(e){
var f=e.target.files[0];if(!f)return;
var r=storage.ref("photos/"+Date.now()+f.name);
r.put(f).then(s=>s.ref.getDownloadURL().then(u=>{
db.ref("mensajes").push({user:user,type:"image",url:u,ts:Date.now()});
}));
};

/* Audio */
let rec,chunks=[];
recordBtn.onclick=async function(){
if(!rec||rec.state==="inactive"){
var st=await navigator.mediaDevices.getUserMedia({audio:true});
rec=new MediaRecorder(st);chunks=[];
rec.ondataavailable=e=>chunks.push(e.data);
rec.onstop=()=>{
var b=new Blob(chunks,{type:"audio/webm"});
var r=storage.ref("audios/"+Date.now()+".webm");
r.put(b).then(s=>s.ref.getDownloadURL().then(u=>{
db.ref("mensajes").push({user:user,type:"audio",url:u,ts:Date.now()});
}));
};
rec.start();this.textContent="â¹ï¸";
}else{rec.stop();this.textContent="ðŸŽ¤";}
};

/* MENÃš SUPERIOR: ONLINE / OFFLINE */
function updateUsers(){
Promise.all([
db.ref("users").once("value"),
db.ref("presence").once("value")
]).then(([u,p])=>{
var online=[];
p.forEach(c=>online.push(c.val().name));
var html="";
u.forEach(c=>{
var n=c.key;
if(online.includes(n)){
html+=`<span class="status online">ðŸŸ¢ ${n}</span>`;
}else{
html+=`<span class="status offline">âšª ${n}</span>`;
}
});
userStatus.innerHTML=html;
});
}

db.ref("presence").on("value",updateUsers);
db.ref("users").on("value",updateUsers);

window.addEventListener("beforeunload",()=>{
if(user)db.ref("users/"+user+"/lastSeen").set(Date.now());
});
</script>
</body>
</html>
<!-- redeploy -->
